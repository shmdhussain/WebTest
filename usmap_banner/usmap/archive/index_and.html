<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, user-scalable=yes"/>
    <style>
        path {
            transition: opacity 100ms linear;
        }
        path:hover  {
            opacity: 1 !important;
        }
        text:hover {
            opacity: 1 !important;
            cursor: pointer;
        }
        path.selected.rep-winner {
            fill: #c25250 !important;
        }
        path.selected.dem-winner {
            fill: #687ad7 !important;
        }
        path.selected.in-progress {
            fill: #9598a6 !important;
        }
    </style>
</head>
<script src="scripts/jquery.min.js" type="text/javascript"></script>
<script src="scripts/raphael.js" type="text/javascript"></script>
<script src="scripts/jquery.usmap.js" type="text/javascript"></script>

<div class="us-map-wrapper">
    <div style="min-height: 250px; margin: 0 auto;" id="map" class=""></div>
</div>

<script>
    window.callbackRenderUsMap = function (data) {
        //callback function to render us map
        renderUsMap();
    };
    var statesList;
    function refreshMap() {
        if (typeof Android != "undefined") {
            window.data = JSON.parse(Android.getMapData());
        }
        statesList = window.data;
        $.each( data, function(key, val) {
            var classString = $('path.' + val.stateCode).attr('class').replace(' rep-winner', '').replace(' dem-winner', '').replace(' in-progress', '');;
            $('path.' + val.stateCode).attr('class', classString);

            if (val.winner === 'REP') {
                //rep is winner
                $('.' + val.stateCode).css('fill', '#9f0706');
                $('.' + val.stateCode + "_hover").css({'fill':'#c25250', 'opacity': '0'});
                $('.' + val.stateCode).attr('class', $('.' + val.stateCode).attr('class') + ' rep-winner');
            }
            else if (val.winner === 'DEM') {
                //dem is winner
                $('.' + val.stateCode).css('fill', '#164cc3');
                $('.' + val.stateCode + "_hover").css({'fill':'#687ad7', 'opacity': '0'});
                $('.' + val.stateCode).attr('class', $('.' + val.stateCode).attr('class') + ' dem-winner');
            } else {
                //counting is in progress or not started
                $('.' + val.stateCode).css('fill', '#676c7f');
                $('.' + val.stateCode + "_hover").css({'fill':'#9598a6', 'opacity': '0'});
                $('.' + val.stateCode).attr('class', $('.' + val.stateCode).attr('class') + ' in-progress');
                $('.' + val.stateCode + "_hover").css({'fill':'#9598a6', 'opacity': '0'});
            }
        });
    }

    function renderUsMap(data) {
        $(document).ready(function(){
            //adjust the map height according to viewport
            $('#map').css('height', $('.media-content-wrapper').width() * 0.65);
            //build the stateHoverStyles
            var stateSpecificStyles = {},
                stateSpecificHoverStyles = {};
                statesList = {};
            $.each( data, function(key, val) {
                statesList[val.stateCode] = val;

                if (val.repIsWinner) {
                    stateSpecificStyles[val.stateCode] = {fill: '#aa120d', name: val.stateCode};
                    stateSpecificHoverStyles[val.stateCode] = {fill: '#c25250', 'stroke': '#FFF'};
                }
                else if (val.demIsWinner == true) {
                    stateSpecificStyles[val.stateCode] = {fill: '#164cc3'};
                    stateSpecificHoverStyles[val.stateCode] = {fill: '#687ad7', 'stroke': '#FFF'};
                } else {
                    stateSpecificHoverStyles[val.stateCode] = {fill: '#9598a6', 'stroke': '#FFF'};
                }
            });

            $('#map').usmap({
                click: function (event, state) {
                    if (typeof Android != "undefined") {
                       Android.selectState(state.name);
                    }
                    if ($('path.selected').length > 0) {
                        var classString = $('path.selected').attr('class').replace(' selected', '');
                        $('path.selected').attr('class', classString);
                    }
                    $('path.' + state.name).attr('class', $('path.' + state.name).attr('class') + ' selected');
                                           //state.shape.animate({"stroke-width": 3.5});

                    if (statesList[state.name].demIsWinner == true || statesList[state.name].repIsWinner == true) {
                        $('.wrap-bar, .legend, .wrap-info-state').hide();
                        $('.winner-bar, .wrap-info, .wrap-info-winner').fadeIn();
                        $('.winner-bar .stateElectoralCount').html(statesList[state.name].stateElectoralCount);

                        if (statesList[state.name].demIsWinner == true) {
                            $('.winner-bar > .candidate').removeClass('rep dem').addClass('dem');
                            $('.winner-bar > .candidate > .candidate-name').html(statesList[state.name].demCandidateArabicName);
                        } else {
                            $('.winner-bar > .candidate').removeClass('rep dem').addClass('rep');
                            $('.winner-bar > .candidate > .candidate-name').html(statesList[state.name].repCandidateArabicName);
                        }
                    } else {
                        $('.winner-bar, .wrap-info-winner').hide();
                        $('.wrap-bar, .wrap-info, .wrap-info-state').fadeIn();
                    }

                    //update the state bar
                    $('#reportingPct').html(statesList[state.name].reportingPct);
                    $('#stateArabicName, .state-name').html(statesList[state.name].stateArabicName);

                    var repPct = statesList[state.name].repCandidatePct;
                    var demPct = statesList[state.name].demCandidatePct;
                    var totalPct = Number(repPct) + Number(demPct);

                    repPct = (repPct * 100) / totalPct;
                    demPct = (demPct * 100) / totalPct;

                    $('.rep-bar').html(Math.round(statesList[state.name].repCandidatePct) + '%');
                    $('.dem-bar').html(Math.round(statesList[state.name].demCandidatePct) + '%');
                },
                showLabels: true,
                labelRadius: 0,
                labelWidth: 40,
                labelHeight: 20,
                labelBackingStyles: {fill: '#676c7f', 'stroke': '#676c7f'},
                stateStyles: {fill: '#676c7f', 'stroke': '#FFFFFF'},
                stateHoverAnimation: 100,
                stateSpecificStyles: stateSpecificStyles,
                stateSpecificHoverStyles: stateSpecificHoverStyles,
                stateSpecificLabelBackingStyles: stateSpecificStyles,
                stateSpecificLabelBackingHoverStyles: stateSpecificHoverStyles
            });
            refreshMap();
        });
    }

    // render us map
    var data;
    if (typeof Android != "undefined") {
        data = JSON.parse(Android.getMapData());
    }
    //console.log("render map")
    renderUsMap(data);
</script>
</html>